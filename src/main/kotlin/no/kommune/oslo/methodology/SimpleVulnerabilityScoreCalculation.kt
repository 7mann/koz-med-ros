package no.kommune.oslo.methodology

import no.kommune.oslo.model.Vulnerability
import no.kommune.oslo.model.enums.SeverityLevel
import no.kommune.oslo.model.enums.SeverityLevel.NONE
import org.apache.logging.log4j.LogManager


object SimpleVulnerabilityScoreCalculation : VulnerabilityScoreCalculation {
    private val logger = LogManager.getLogger(javaClass)

    override fun calculateVulnerability(vulnerability: Vulnerability,
                                        threatPresence: SeverityLevel,
                                        riskTreatment: SeverityLevel): SeverityLevel {

        if (vulnerability == null) {
            logger.warn("Illegal argument! Vulnerability must be present.")
            throw IllegalArgumentException("Illegal argument combination! No exploiting threats, but existing threatPresence value.")
        }
        if (threatPresence == NONE) {
            logger.debug("$threatPresence threat presence, setting Severity Level to $NONE")
            return NONE
        }

        // Average threat presence with vulnerability score
        var calculatedVulnerability = (vulnerability.vulnerabilityPotential.severityLevelValue + threatPresence.severityLevelValue) / 2
        logger.debug("threatPresenceScore: $threatPresence=${threatPresence.severityLevelValue}, " +
                "vulnerabilityPotential: ${vulnerability.vulnerabilityPotential}=${vulnerability.vulnerabilityPotential.severityLevelValue}, " +
                "calculated existing vulnerability $calculatedVulnerability")

        if (riskTreatment == NONE) {
            logger.debug("No risk treatments, vulnerability potential (${vulnerability.vulnerabilityPotential}) is not reduced.")
            return SeverityLevel.roundSeverityLevel(calculatedVulnerability)
        }

        calculatedVulnerability -= riskTreatment.severityLevelValue //reduce vulnerability potential
        if (calculatedVulnerability < 0) {
            logger.debug("Negative vulnerability score ($calculatedVulnerability) not allowed. Setting calculated vulnerability to 0.")
            calculatedVulnerability = 0// Do not allow negative numbers
        }

        return SeverityLevel.roundSeverityLevel(calculatedVulnerability)
    }
}
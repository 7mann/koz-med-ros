package no.kommune.oslo.methodology

import no.kommune.oslo.model.RiskTestFactory
import no.kommune.oslo.model.SeverityLevels.*
import no.kommune.oslo.model.Vulnerability
import no.kommune.oslo.model.VulnerabilityTypes.TECHNICAL
import org.apache.logging.log4j.LogManager
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.Test
import kotlin.test.assertFailsWith

internal class SimpleVulnerabilityScoreCalculationTest {
    private val logger = LogManager.getLogger(javaClass)

    @Test
    fun `Expect calculated vulnerability NONE without any exploiting threats`() {
        val vulnerability = Vulnerability(
                vulnerabilityType = TECHNICAL,
                vulnerabilityDescription = "Test vulnerability 1",
                vulnerabilityPotential = HIGH, exploitedByThreats = emptyList(), riskTreatments = emptyList()
        )
        val valScore = SimpleVulnerabilityScoreCalculation.calculateVulnerability(
                vulnerability = vulnerability,
                threatPresence = NONE,
                riskTreatment = LOW
        )
        assertThat(valScore).isEqualTo(NONE)
        logger.debug("valScore: $valScore")
    }

    @Test
    fun `Expect exception thrown with no threats and present threat presence value`() {
        var vulnerability = Vulnerability(
                vulnerabilityType = TECHNICAL,
                vulnerabilityDescription = "Test vulnerability 1",
                vulnerabilityPotential = HIGH, exploitedByThreats = emptyList(), riskTreatments = emptyList()
        )
        assertFailsWith<IllegalArgumentException> {
            SimpleVulnerabilityScoreCalculation.calculateVulnerability(
                    vulnerability = vulnerability,
                    threatPresence = EXTREME,
                    riskTreatment = LOW
            )
        }

        vulnerability = vulnerability.copy(exploitedByThreats = RiskTestFactory.createModerateThreatList())
        assertFailsWith<IllegalArgumentException> {
            SimpleVulnerabilityScoreCalculation.calculateVulnerability(
                    vulnerability = vulnerability,
                    threatPresence = NONE,
                    riskTreatment = LOW
            )
        }

    }

    @Test
    fun `Expect calculated vulnerability MODERATE with EXTREME threat presence and LOW risk treatment`() {
        val vulnerability = Vulnerability(
                vulnerabilityType = TECHNICAL,
                vulnerabilityDescription = "Test vulnerability 1",
                vulnerabilityPotential = HIGH, exploitedByThreats = RiskTestFactory.createModerateThreatList(), riskTreatments = RiskTestFactory.createMixedRiskTreatmentList()
        )
        val valScore = SimpleVulnerabilityScoreCalculation.calculateVulnerability(
                vulnerability = vulnerability,
                threatPresence = EXTREME,
                riskTreatment = LOW
        )
        assertThat(valScore).isEqualTo(MODERATE)
        logger.debug("valScore: $valScore")
    }
}